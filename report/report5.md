
## lab5 实验报告
本实验已完成所有的必做和选做内容

### 一、编译与测试命令
编译可以使用：
  > make parser（或直接make）

### 二、整体设计
实验五和之前实验不同，几乎不需要之前的实验内容，所有定义和实现都在``optimizer.c``和``optimizer.h``中，main.c只负责调用读入、优化和打印三个模块的接口并传入相应的文件路径参数。
```C
//main.c调用三个模块执行：读入、优化、打印
    readinput(argv[1]);
    optimize();
    printoutput(argv[2]);
```
其中，``readinput()``函数读取输入文件信息，将代码分块存储到基本块的数据结构``BasicBlock``数组中，每一个基本块中存放中间代码的方式和实验3一样使用名为``InterCode``链表；``optimize()``是处理优化的主函数，先对每个基本块内单独优化再进行全局优化；``printoutput()``函数将所有基本块内优化过的代码按顺序打印。

### 三、具体实现
#### 1.数据结构
基本块数据结构如下，这是一个类似链表的数据结构。
```C
//基本块的数据结构
struct BasicBlock_ {
    int no;//序号
    struct InterCode_* codehead;//中间代码的链表头
    struct InterCode_* codetail;//中间代码的链表头
    int prenum;//前驱数量
    struct BasicBlock_ **prev;//前驱很多,用数组
    struct BasicBlock_ *next[2]; //后驱的基本块最多就两个（因为IF），记录两个指针
};
```
实际使用时，使用的是其指针数组 ``BasicBlock* bb`` 的形式而非结构体，这是由于索引方便，每个基本块直接用序号查找数组即可，但数组应该申请多少大小呢？我们考虑过两种解决方案，一是在输入处理时提前进行一趟遍历，看看有多少会产生新基本块的语句，即可得到大致数量；二是先开辟一个小的数组，如果不够用了就用拷贝加倍方式增加其大小。两种方法各有优劣，我们采用了第一种更为直观的方法。

#### 2.输入模块
输入模块其实就是一个while循环逐行读入文件中的代码，然后检测代码类型，如果是LABEL等代表新基本块开头的语句就新增基本块，如果是GOTO等代表基本块结尾的语句就将当前基本块设置为空。为了方便将文本转化为操作数并进一步生成代码使用函数``Operand makeop(char *name)``和``InterCode AddInterCode(BasicBlock block,int codekind,Operand op0,Operand op1,Operand op2)``增加代码复用性
#### 3.基本块内优化
基本块内的优化主要是创建DAG后消除常数、消除公共子表达式、消除死代码。

**3.1 创建DAG**

DAG数据结构设置如下：
```C
//DAG节点数据结构
struct DAGNode_{
    enum {
        ASSIGN_NODE, ADD_NODE, SUB_NODE, MUL_NODE, DIV_NODE, LEAF_NODE
    } kind; // 节点的类型
    int no;//数组序号
    int used;//节点被使用次数
    Operand op;//节点上的操作数
    DAGNode leftchild,rightchild;//左右子树
};
```
对每一条语句中的变量或常数创造DAG节点，创建DAG的关键在于变量不同版本的记录，这里采用的方法是对于最新获取的变量名使用函数``DAGNode SearchOperand(Operand op,int flag)``遍历当前DAG上的所有节点找到变量最新版本号，如果是被赋值就创建一个更新版本的节点，如果是一次使用就增加一次节点被使用次数（用于后续消除死代码）。

**3.2 常量折叠**

首先进行常量折叠，对于DAG中赋值的子节点是数值的情况，直接将父节点替换成子节点的同时，查找代码中所有该版本的变量替换成常量，被赋值语句删除即可，然后重复此过程直到没有常量可以折叠。

**3.3 消除公共子表达式**

类似常量折叠，只要在DAG中找到相同左右子树操作数的节点，就可以将后一个节点直接替换为前一个，方式是在DAG上改为赋值关系，同样替换原代码中的该版本变量，重复直到没有可以消除的。

**3.4 消除无用代码**

这里前面定义的使用次数就可以用到了，在DAG中找到那些节点使用次数为0且不是最新版本的变量（最新版本无法判断是否出口活跃），进行删除即可，删除代码中对这些变量的赋值，重复直到没有可以消除的。

#### 4.全局优化

#### 5.打印输出
打印部分更加简单，Lab3基本已经写过，按顺序对每个基本块内代码进行打印即可。